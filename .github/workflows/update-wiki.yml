name: Update Wiki from DeepWiki

on:
  push:
    branches:
      - main

jobs:
  update-wiki:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Clone DeepWiki MCP
        run: |
          git clone https://github.com/regenrek/deepwiki-mcp.git deepwiki-mcp
          cd deepwiki-mcp

      - name: Build DeepWiki MCP
        working-directory: deepwiki-mcp
        run: |
          npm install
          npm run build

      - name: Start DeepWiki MCP (HTTP mode)
        working-directory: deepwiki-mcp
        run: |
          node ./bin/cli.mjs --http --port 3000 > ../deepwiki.log 2>&1 &
          DEEPWIKI_PID=$!
          for i in {1..30}; do
            sleep 2
            if curl -s http://localhost:3000/mcp > /dev/null; then
              echo "✅ DeepWiki MCP is available"
              break
            fi
            echo "⏳ Waiting for DeepWiki MCP… intento $i/30"
          done

      # === Debug: Dump server logs ===
      - name: Dump DeepWiki MCP logs
        if: always()
        run: |
          echo "---- Últimos 50 líneas de deepwiki.log ----"
          tail -n 50 ../deepwiki.log || true

      - name: Export ALL Markdown from DeepWiki
        run: |
          DEEPWIKI_URL="https://deepwiki.com/VforVitorio/F1_Strat_Manager"
          echo "Testing DeepWiki URL: $DEEPWIKI_URL"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DEEPWIKI_URL")
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "❌ Error: DeepWiki URL returned HTTP $HTTP_STATUS"
            exit 1
          fi

          JSON_PAYLOAD='{"jsonrpc":"2.0","method":"tools/call","params":{"url":"'"$DEEPWIKI_URL"'","maxDepth":1,"mode":"pages","verbose":true},"id":1}'
          HTTP_CODE=$(curl -X POST http://localhost:3000/mcp \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            -o docs-md/all-pages-raw.json \
            -w "%{http_code}" \
            -s)
          echo "HTTP status code: $HTTP_CODE"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "❌ All strategies failed with HTTP $HTTP_CODE"
            exit 1
          fi

      # === Debug: Dump raw JSON response ===
      - name: Dump raw JSON response
        if: always()
        run: |
          echo "---- Contenido de docs-md/all-pages-raw.json ----"
          cat docs-md/all-pages-raw.json || echo "(archivo vacío o no creado)"
          echo
          if command -v jq >/dev/null; then
            echo "---- Formateado con jq ----"
            jq . docs-md/all-pages-raw.json || echo "(JSON inválido)"
          fi

      - name: Commit and push changes
        working-directory: wiki
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --quiet --staged; then
            echo "No changes to commit"
          else
            git commit -m "🔄 Update Complete Wiki from DeepWiki - $(date '+%Y-%m-%d %H:%M')"
            git push
            echo "Changes pushed successfully"
          fi
